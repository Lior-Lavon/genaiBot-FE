# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

# trigger:
#   branches:
#     include:
#       - main # or your deployment branch

# pool:
#   vmImage: "ubuntu-latest"

# steps:
#   - task: NodeTool@0
#     inputs:
#       versionSpec: "18.x" # or whatever version you use
#     displayName: "Use Node.js"

#   - script: npm install
#     displayName: "Install dependencies"

#   - script: npm run build
#     displayName: "Build React App"

#   - task: AzureWebApp@1
#     inputs:
#       azureSubscription: "chatbot-service-connection" # service connection name
#       appName: "genie-bot-frontend" # Azure App Service name
#       package: "$(System.DefaultWorkingDirectory)/build" # React build output

trigger:
  branches:
    include:
      - main

pool:
  vmImage: "ubuntu-latest"

variables:
  appName: "genie-bot-frontend"
  packageDir: "dist" # Vite uses dist/ instead of build/

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: "18.x"
    displayName: "Install Node.js"

  - script: |
      npm install
      npm run build  # Ensure you're using the default Vite build script
    displayName: "Install dependencies and build Vite app"
    env:
      VITE_API_BASE_URL:
      "https://genie-bot-backend.azurewebsites.net/api/v1"

  - script: |
      echo "Listing root and dist folder"
      ls -la
      ls -la dist  # Check if the dist/ folder exists
    displayName: "Debug: check dist output"

  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: "$(packageDir)"
      includeRootFolder: false
      archiveType: "zip"
      archiveFile: "$(Build.ArtifactStagingDirectory)/vite-app.zip"
      replaceExistingArchive: true
    displayName: "Archive Vite build output"

  - task: AzureWebApp@1
    inputs:
      azureSubscription: "chatbot-service-connection"
      appType: "webAppLinux"
      appName: "$(appName)"
      package: "$(Build.ArtifactStagingDirectory)/vite-app.zip"
    displayName: "Deploy to Azure Web App"
